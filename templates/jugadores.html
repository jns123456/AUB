{% extends "base.html" %}
{% load l10n %}

{% block title %}Jugadores{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-gray-800"><i class="bi bi-people"></i> Jugadores</h2>
    <div class="flex items-center gap-3">
        <a href="{% url 'cargar_base' %}" class="inline-flex items-center gap-2 px-4 py-2 bg-bridge text-white rounded-lg hover:bg-bridge-light transition text-sm font-medium">
            <i class="bi bi-database-up"></i> Cargar Base
        </a>
        {% if jugadores %}
        <form action="{% url 'jugadores_eliminar_todos' %}" method="POST" class="inline"
              onsubmit="return confirm('¿ELIMINAR TODOS LOS JUGADORES?\n\nEsta acción borrará los {{ jugadores|length }} jugadores de la base de datos y las parejas de todos los torneos.\n\nEsta acción NO se puede deshacer.')">
            {% csrf_token %}
            <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 border border-red-500 text-red-500 rounded-lg hover:bg-red-50 transition text-sm font-medium">
                <i class="bi bi-trash3"></i> Eliminar toda la base
            </button>
        </form>
        {% endif %}
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
    <!-- Formulario de nuevo jugador -->
    <div class="lg:col-span-1 space-y-6">
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="bg-bridge text-white px-4 py-3">
                <h5 class="font-semibold text-sm"><i class="bi bi-person-plus"></i> Agregar Jugador</h5>
            </div>
            <div class="p-4">
                <form action="{% url 'jugador_nuevo' %}" method="POST">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                        <input type="text" id="nombre" name="nombre" required
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-bridge/20 focus:border-bridge transition">
                    </div>
                    <div class="mb-3">
                        <label for="apellido" class="block text-sm font-medium text-gray-700 mb-1">Apellido</label>
                        <input type="text" id="apellido" name="apellido" required
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-bridge/20 focus:border-bridge transition">
                    </div>
                    <div class="mb-3">
                        <label for="handicap" class="block text-sm font-medium text-gray-700 mb-1">Handicap</label>
                        <input type="number" step="0.1" id="handicap" name="handicap" value="0" required
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-bridge/20 focus:border-bridge transition">
                        <p class="text-xs text-gray-500 mt-1">-1 = mejor nivel, números más altos = menor nivel.</p>
                    </div>
                    <div class="mb-3">
                        <label for="puntos" class="block text-sm font-medium text-gray-700 mb-1">Puntos</label>
                        <input type="number" step="0.01" id="puntos" name="puntos" value="0"
                               class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-bridge/20 focus:border-bridge transition">
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label for="cn_totales" class="block text-sm font-medium text-gray-700 mb-1">CN Totales</label>
                            <input type="number" id="cn_totales" name="cn_totales" value="0"
                                   class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-bridge/20 focus:border-bridge transition">
                        </div>
                        <div>
                            <label for="categoria" class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                            <select id="categoria" name="categoria"
                                    class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-bridge/20 focus:border-bridge transition">
                                <option value="">— Sin categoría —</option>
                                {% for cat in categorias %}
                                <option value="{{ cat }}">{{ cat }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="inline-flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" name="es_director" value="1"
                                   class="w-4 h-4 text-bridge border-gray-300 rounded focus:ring-bridge/20">
                            <span class="text-sm text-gray-700">Autorizado como Director de Torneo</span>
                        </label>
                    </div>
                    <button type="submit" class="w-full inline-flex items-center justify-center gap-2 px-4 py-2 bg-bridge text-white rounded-lg hover:bg-bridge-light transition text-sm font-medium">
                        <i class="bi bi-plus-circle"></i> Agregar
                    </button>
                </form>
            </div>
        </div>

        <!-- Importar CSV -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-200">
                <h5 class="font-semibold text-sm"><i class="bi bi-upload"></i> Importar desde CSV</h5>
            </div>
            <div class="p-4">
                <form action="{% url 'jugadores_importar' %}" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <input type="file" name="archivo_csv" accept=".csv" required
                               class="w-full text-sm text-gray-500 file:mr-2 file:py-2 file:px-3 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-bridge/10 file:text-bridge hover:file:bg-bridge/20 transition">
                        <p class="text-xs text-gray-500 mt-2">
                            Formato: <code class="bg-gray-100 px-1 rounded">nombre,apellido,handicap</code><br>
                            Una fila por jugador, sin encabezados.
                        </p>
                    </div>
                    <button type="submit" class="w-full inline-flex items-center justify-center gap-2 px-4 py-2 border border-blue-500 text-blue-500 rounded-lg hover:bg-blue-50 transition text-sm font-medium">
                        <i class="bi bi-upload"></i> Importar
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Lista de jugadores -->
    <div class="lg:col-span-3">
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-200 flex justify-between items-center flex-wrap gap-2">
                <h5 class="font-semibold text-sm">
                    <i class="bi bi-list-ul"></i> Lista de Jugadores
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-bridge text-white ml-2">{{ jugadores|length }}</span>
                </h5>
                <div class="flex items-center gap-2">
                    <button type="button" class="px-3 py-1.5 text-xs font-medium bg-bridge text-white rounded-lg shadow-sm" id="btn-ranking-aub"
                            title="Ordenar por Ranking AUB (Categoría + Puntos)">
                        <i class="bi bi-trophy-fill"></i> Ranking AUB
                    </button>
                    <input type="text" id="buscar-jugador"
                           class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-bridge/20 focus:border-bridge transition w-48"
                           placeholder="Buscar...">
                </div>
            </div>
            <div>
                {% if jugadores %}
                <div class="overflow-x-auto">
                    <table class="w-full" id="tabla-jugadores">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-center text-xs font-semibold text-gray-500 uppercase w-12">#</th>
                                <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase cursor-pointer select-none sortable hover:text-bridge" data-col="1" data-tipo="texto">
                                    Nombre <i class="bi bi-arrow-down-up sort-icon text-gray-400 text-xs"></i>
                                </th>
                                <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase cursor-pointer select-none sortable hover:text-bridge" data-col="2" data-tipo="texto">
                                    Apellido <i class="bi bi-arrow-down-up sort-icon text-gray-400 text-xs"></i>
                                </th>
                                <th class="px-3 py-3 text-center text-xs font-semibold text-gray-500 uppercase cursor-pointer select-none sortable hover:text-bridge" data-col="3" data-tipo="numero">
                                    HC <i class="bi bi-arrow-down-up sort-icon text-gray-400 text-xs"></i>
                                </th>
                                <th class="px-3 py-3 text-center text-xs font-semibold text-gray-500 uppercase cursor-pointer select-none sortable hover:text-bridge" data-col="4" data-tipo="numero">
                                    Puntos <i class="bi bi-arrow-down-up sort-icon text-gray-400 text-xs"></i>
                                </th>
                                <th class="px-3 py-3 text-center text-xs font-semibold text-gray-500 uppercase cursor-pointer select-none sortable hover:text-bridge" data-col="5" data-tipo="numero">
                                    Puntos 2026 <i class="bi bi-arrow-down-up sort-icon text-gray-400 text-xs"></i>
                                </th>
                                <th class="px-3 py-3 text-center text-xs font-semibold text-gray-500 uppercase cursor-pointer select-none sortable hover:text-bridge" data-col="6" data-tipo="numero">
                                    CN <i class="bi bi-arrow-down-up sort-icon text-gray-400 text-xs"></i>
                                </th>
                                <th class="px-3 py-3 text-center text-xs font-semibold text-gray-500 uppercase cursor-pointer select-none sortable hover:text-bridge" data-col="7" data-tipo="texto">
                                    Categoría <i class="bi bi-arrow-down-up sort-icon text-gray-400 text-xs"></i>
                                </th>
                                <th class="px-3 py-3 text-right text-xs font-semibold text-gray-500 uppercase">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            {% for jugador in jugadores %}
                            <tr class="fila-jugador hover:bg-gray-50 transition">
                                <td class="px-3 py-2.5 text-center text-gray-400 text-sm rank-num">{{ forloop.counter }}</td>
                                <td class="px-3 py-2.5 text-sm text-gray-900">
                                    <a href="{% url 'jugador_perfil' id=jugador.id %}" class="text-bridge hover:underline font-medium">{{ jugador.nombre }}</a>
                                    {% if jugador.es_director %}<i class="bi bi-person-badge text-bridge ml-1" title="Director autorizado"></i>{% endif %}
                                </td>
                                <td class="px-3 py-2.5 text-sm text-gray-900">
                                    <a href="{% url 'jugador_perfil' id=jugador.id %}" class="text-bridge hover:underline font-medium">{{ jugador.apellido }}</a>
                                </td>
                                <td class="px-3 py-2.5 text-center">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                                        {% if jugador.handicap <= 0 %}bg-red-100 text-red-800
                                        {% elif jugador.handicap <= 3 %}bg-yellow-100 text-yellow-800
                                        {% elif jugador.handicap <= 6 %}bg-blue-100 text-blue-800
                                        {% else %}bg-gray-100 text-gray-800
                                        {% endif %}">
                                        {{ jugador.handicap }}
                                    </span>
                                </td>
                                <td class="px-3 py-2.5 text-center text-sm text-gray-700">{{ jugador.puntos|default:0 }}</td>
                                <td class="px-3 py-2.5 text-center text-sm text-gray-700">{{ jugador.puntos_2026|default:0 }}</td>
                                <td class="px-3 py-2.5 text-center text-sm text-gray-700">{{ jugador.cn_totales|default:0 }}</td>
                                <td class="px-3 py-2.5 text-center">
                                    {% if jugador.categoria %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                                        {% if jugador.categoria == 'GM' or jugador.categoria == 'GRAN MAESTRO' or jugador.categoria == 'MAESTRO' %}bg-gray-900 text-white
                                        {% elif jugador.categoria == 'SUPERIOR' %}bg-blue-600 text-white
                                        {% elif jugador.categoria == 'PRIMERA' %}bg-green-600 text-white
                                        {% elif jugador.categoria == 'SEGUNDA' %}bg-cyan-100 text-cyan-800
                                        {% elif jugador.categoria == 'TERCERA' %}bg-yellow-100 text-yellow-800
                                        {% elif jugador.categoria == 'CUARTA' %}bg-gray-200 text-gray-700
                                        {% elif jugador.categoria == 'QUINTA' %}bg-gray-100 text-gray-600
                                        {% elif jugador.categoria == 'PRINCIPIANTES' or jugador.categoria == 'PRINCIPIANTE' %}bg-gray-50 text-gray-500
                                        {% else %}bg-gray-100 text-gray-700
                                        {% endif %}">{{ jugador.categoria }}</span>
                                    {% endif %}
                                </td>
                                <td class="px-3 py-2.5 text-right">
                                    <button type="button" class="p-1.5 text-blue-500 hover:bg-blue-50 rounded-lg transition btn-editar-jugador"
                                            data-id="{{ jugador.id }}"
                                            data-nombre="{{ jugador.nombre }}"
                                            data-apellido="{{ jugador.apellido }}"
                                            data-handicap="{{ jugador.handicap|default_if_none:0|unlocalize }}"
                                            data-puntos="{{ jugador.puntos|default_if_none:0|unlocalize }}"
                                            data-cn="{{ jugador.cn_totales|default_if_none:0 }}"
                                            data-categoria="{{ jugador.categoria|default_if_none:'' }}"
                                            data-es-director="{{ jugador.es_director|yesno:'1,0' }}"
                                            data-url="{% url 'jugador_editar' id=jugador.id %}">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <form action="{% url 'jugador_eliminar' id=jugador.id %}"
                                          method="POST" class="inline"
                                          onsubmit="return confirm('¿Eliminar a {{ jugador.nombre_completo }}?')">
                                        {% csrf_token %}
                                        <button type="submit" class="p-1.5 text-red-500 hover:bg-red-50 rounded-lg transition">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-12 text-gray-400">
                    <i class="bi bi-person-x" style="font-size: 3rem;"></i>
                    <p class="mt-3 text-gray-500">No hay jugadores registrados aún.</p>
                    <p class="text-sm text-gray-400">Agregá jugadores usando el formulario o importá un archivo CSV.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal de edición con Alpine.js -->
<div x-data="{ open: false, url: '', nombre: '', apellido: '', handicap: 0, puntos: 0, cn: 0, categoria: '', es_director: false }"
     @editar-jugador.window="open = true; url = $event.detail.url; nombre = $event.detail.nombre; apellido = $event.detail.apellido; handicap = $event.detail.handicap; puntos = $event.detail.puntos; cn = $event.detail.cn; categoria = $event.detail.categoria; es_director = $event.detail.es_director === '1'"
     x-show="open" x-transition.opacity
     class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"
     style="display: none;">
    <div @click.outside="open = false" x-transition class="bg-white rounded-xl shadow-xl w-full max-w-md mx-4">
        <form :action="url" method="POST">
            {% csrf_token %}
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h5 class="font-semibold text-lg">Editar Jugador</h5>
                <button type="button" @click="open = false" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                    <input type="text" name="nombre" x-model="nombre" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bridge/20 focus:border-bridge transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Apellido</label>
                    <input type="text" name="apellido" x-model="apellido" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bridge/20 focus:border-bridge transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Handicap</label>
                    <input type="number" step="0.1" name="handicap" x-model="handicap" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bridge/20 focus:border-bridge transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Puntos</label>
                    <input type="number" step="0.01" name="puntos" x-model="puntos"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bridge/20 focus:border-bridge transition">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">CN Totales</label>
                        <input type="number" name="cn_totales" x-model="cn"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bridge/20 focus:border-bridge transition">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                        <select name="categoria" x-model="categoria"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bridge/20 focus:border-bridge transition">
                            <option value="">— Sin categoría —</option>
                            {% for cat in categorias %}
                            <option value="{{ cat }}" :selected="categoria === '{{ cat }}'">{{ cat }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div>
                    <label class="inline-flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" name="es_director" value="1" x-model="es_director"
                               class="w-4 h-4 text-bridge border-gray-300 rounded focus:ring-bridge/20">
                        <span class="text-sm text-gray-700">Autorizado como Director de Torneo</span>
                    </label>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 flex justify-end gap-3">
                <button type="button" @click="open = false" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">Cancelar</button>
                <button type="submit" class="px-4 py-2 bg-bridge text-white rounded-lg hover:bg-bridge-light transition font-medium">Guardar</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const tabla = document.getElementById('tabla-jugadores');
    if (!tabla) return;

    const tbody = tabla.querySelector('tbody');
    const headers = tabla.querySelectorAll('th.sortable');
    const btnRanking = document.getElementById('btn-ranking-aub');
    let ordenActual = { col: null, asc: true };
    let rankingAubActivo = true;

    const CATEGORIA_ORDEN = {
        'GRAN MAESTRO': 0, 'GM': 0, 'MAESTRO': 1, 'SUPERIOR': 2,
        'PRIMERA': 3, 'SEGUNDA': 4, 'TERCERA': 5, 'CUARTA': 6,
        'QUINTA': 7, 'PRINCIPIANTES': 8, 'PRINCIPIANTE': 8,
    };

    const COL_RANK = 0, COL_NOMBRE = 1, COL_APELLIDO = 2, COL_HC = 3,
          COL_PUNTOS = 4, COL_PUNTOS_2026 = 5, COL_CN = 6, COL_CAT = 7;

    function obtenerFilas() { return Array.from(tbody.querySelectorAll('tr.fila-jugador')); }
    function reinsertarFilas(filas) { filas.forEach(fila => tbody.appendChild(fila)); }

    function renumerarFilas() {
        let pos = 0;
        Array.from(tbody.querySelectorAll('tr.fila-jugador')).forEach(fila => {
            if (fila.style.display !== 'none') { pos++; fila.children[COL_RANK].textContent = pos; }
        });
    }

    function resetSortIcons() {
        headers.forEach(h => { h.querySelector('.sort-icon').className = 'bi bi-arrow-down-up sort-icon text-gray-400 text-xs'; });
    }

    btnRanking.addEventListener('click', function() {
        const filas = obtenerFilas();
        filas.sort((a, b) => {
            const catA = a.children[COL_CAT].textContent.trim().toUpperCase();
            const catB = b.children[COL_CAT].textContent.trim().toUpperCase();
            const ordenA = CATEGORIA_ORDEN[catA] !== undefined ? CATEGORIA_ORDEN[catA] : 99;
            const ordenB = CATEGORIA_ORDEN[catB] !== undefined ? CATEGORIA_ORDEN[catB] : 99;
            if (ordenA !== ordenB) return ordenA - ordenB;
            const puntosA = parseFloat(a.children[COL_PUNTOS].textContent.trim()) || 0;
            const puntosB = parseFloat(b.children[COL_PUNTOS].textContent.trim()) || 0;
            return puntosB - puntosA;
        });
        reinsertarFilas(filas);
        renumerarFilas();
        ordenActual = { col: null, asc: true };
        resetSortIcons();
        rankingAubActivo = true;
        btnRanking.className = 'px-3 py-1.5 text-xs font-medium bg-bridge text-white rounded-lg shadow-sm';
    });

    headers.forEach(th => {
        th.addEventListener('click', function() {
            const col = parseInt(this.dataset.col);
            const tipo = this.dataset.tipo;
            if (ordenActual.col === col) { ordenActual.asc = !ordenActual.asc; }
            else { ordenActual.col = col; ordenActual.asc = true; }

            const filas = obtenerFilas();
            filas.sort((a, b) => {
                let valA, valB;
                if (tipo === 'numero') {
                    valA = parseFloat(a.children[col].textContent.trim()) || 0;
                    valB = parseFloat(b.children[col].textContent.trim()) || 0;
                    return ordenActual.asc ? valA - valB : valB - valA;
                } else {
                    valA = a.children[col].textContent.trim().toLowerCase();
                    valB = b.children[col].textContent.trim().toLowerCase();
                    const cmp = valA.localeCompare(valB, 'es');
                    return ordenActual.asc ? cmp : -cmp;
                }
            });
            reinsertarFilas(filas);
            renumerarFilas();

            rankingAubActivo = false;
            btnRanking.className = 'px-3 py-1.5 text-xs font-medium border border-bridge text-bridge rounded-lg hover:bg-bridge hover:text-white transition';

            headers.forEach(h => {
                const icon = h.querySelector('.sort-icon');
                const c = parseInt(h.dataset.col);
                if (c === col) {
                    icon.className = ordenActual.asc ? 'bi bi-sort-up sort-icon text-bridge text-xs' : 'bi bi-sort-down sort-icon text-bridge text-xs';
                } else {
                    icon.className = 'bi bi-arrow-down-up sort-icon text-gray-400 text-xs';
                }
            });
        });
    });

    document.getElementById('buscar-jugador').addEventListener('input', function() {
        const filtro = this.value.toLowerCase();
        tbody.querySelectorAll('tr.fila-jugador').forEach(fila => {
            fila.style.display = fila.textContent.toLowerCase().includes(filtro) ? '' : 'none';
        });
        renumerarFilas();
    });

    // Edit button - dispatch Alpine.js custom event
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.btn-editar-jugador');
        if (!btn) return;
        e.preventDefault();
        window.dispatchEvent(new CustomEvent('editar-jugador', {
            detail: {
                url: btn.dataset.url,
                nombre: btn.dataset.nombre || '',
                apellido: btn.dataset.apellido || '',
                handicap: parseFloat((btn.dataset.handicap || '0').replace(',', '.')) || 0,
                puntos: parseFloat((btn.dataset.puntos || '0').replace(',', '.')) || 0,
                cn: btn.dataset.cn || '0',
                categoria: btn.dataset.categoria || '',
                es_director: btn.dataset.esDirector || '0',
            }
        }));
    });
})();
</script>
{% endblock %}
