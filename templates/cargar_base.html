{% extends "base.html" %}

{% block title %}Cargar Base de Handicaps{% endblock %}

{% block content %}

{% if not preview %}
<!-- PASO 1: SUBIR ARCHIVO -->
<div class="flex justify-center">
    <div class="w-full max-w-3xl space-y-6">
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="bg-bridge text-white px-6 py-4">
                <h4 class="font-semibold text-lg"><i class="bi bi-database-up"></i> Cargar Base de Handicaps</h4>
            </div>
            <div class="p-6">
                <p class="text-gray-500 mb-6">
                    Subí la base de datos histórica con los handicaps de los jugadores.
                    El sistema detecta automáticamente las columnas y te muestra una vista previa
                    antes de importar.
                </p>

                <form action="{% url 'cargar_base' %}" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div x-data="{ fileName: '' }" class="mb-6">
                        <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-bridge transition cursor-pointer"
                             id="uploadArea"
                             @dragenter.prevent="$el.classList.add('border-bridge', 'bg-bridge/5')"
                             @dragover.prevent
                             @dragleave.prevent="$el.classList.remove('border-bridge', 'bg-bridge/5')"
                             @drop.prevent="$el.classList.remove('border-bridge', 'bg-bridge/5'); $refs.fileInput.files = $event.dataTransfer.files; fileName = $refs.fileInput.files[0]?.name || ''"
                             @click="$refs.fileInput.click()">
                            <i class="bi bi-cloud-arrow-up text-bridge" style="font-size: 3rem;"></i>
                            <h5 class="mt-3 font-semibold text-gray-700">Arrastrá tu archivo acá o hacé clic para seleccionar</h5>
                            <p class="text-gray-400 text-sm mb-3">Formatos aceptados: .csv, .xlsx</p>
                            <input type="file" name="archivo" x-ref="fileInput"
                                   @change="fileName = $refs.fileInput.files[0]?.name || ''"
                                   accept=".csv,.xlsx,.txt" required class="hidden">
                            <div x-show="fileName" x-text="'Archivo: ' + fileName" class="mt-2 font-medium text-bridge"></div>
                        </div>
                    </div>
                    <button type="submit" class="w-full inline-flex items-center justify-center gap-2 px-6 py-3 bg-bridge text-white rounded-lg hover:bg-bridge-light transition font-medium text-lg">
                        <i class="bi bi-eye"></i> Ver Vista Previa
                    </button>
                </form>
            </div>
        </div>

        <!-- Instrucciones -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden" x-data="{ tab: 'combinado' }">
            <div class="px-6 py-3 border-b border-gray-200">
                <h5 class="font-semibold"><i class="bi bi-question-circle"></i> Formato del archivo</h5>
            </div>
            <div class="p-6">
                <p class="text-gray-600 mb-4">El archivo puede tener <strong>2 o 3 columnas</strong>.</p>

                <div class="flex gap-2 mb-4">
                    <button @click="tab = 'combinado'"
                            :class="tab === 'combinado' ? 'bg-bridge text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                            class="px-4 py-2 rounded-lg text-sm font-medium transition">
                        Columna combinada
                    </button>
                    <button @click="tab = 'separado'"
                            :class="tab === 'separado' ? 'bg-bridge text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                            class="px-4 py-2 rounded-lg text-sm font-medium transition">
                        Columnas separadas
                    </button>
                </div>

                <div x-show="tab === 'combinado'">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-sm text-green-800 mb-4">
                        <i class="bi bi-star-fill"></i>
                        <strong>Formato AUB:</strong> Si tu archivo tiene una columna "Nombre"
                        con el <strong>apellido primero y el nombre después</strong>, el sistema
                        los separa automáticamente.
                    </div>
                    <div class="text-sm text-gray-500">
                        Acepta: <code class="bg-gray-100 px-1 rounded">Apellido, Nombre</code> o <code class="bg-gray-100 px-1 rounded">Apellido Nombre</code>
                    </div>
                </div>

                <div x-show="tab === 'separado'">
                    <div class="bg-gray-50 rounded-lg p-3 font-mono text-sm">
                        nombre,apellido,handicap<br>
                        Juan,Pérez,-1<br>
                        María,González,3.5
                    </div>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-blue-800 mt-4">
                    <i class="bi bi-info-circle"></i>
                    <strong>Detección automática:</strong>
                    Nombre, Apellido, Handicap, Puntos, CN Totales, Categoría
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- PASO 2: VISTA PREVIA -->
<div class="max-w-5xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold text-gray-800"><i class="bi bi-eye"></i> Vista Previa de Importación</h3>
        <a href="{% url 'cargar_base' %}" class="inline-flex items-center gap-2 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
            <i class="bi bi-arrow-left"></i> Subir otro archivo
        </a>
    </div>

    <!-- Resumen -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-xl shadow-sm text-center p-4">
            <div class="text-3xl font-bold text-bridge">{{ total }}</div>
            <small class="text-gray-500">Total encontrados</small>
        </div>
        <div class="bg-white rounded-xl shadow-sm text-center p-4">
            <div class="text-3xl font-bold text-green-600">{{ nuevos }}</div>
            <small class="text-gray-500">Jugadores nuevos</small>
        </div>
        <div class="bg-white rounded-xl shadow-sm text-center p-4">
            <div class="text-3xl font-bold text-yellow-600">{{ actualizados }}</div>
            <small class="text-gray-500">A actualizar</small>
        </div>
        <div class="bg-white rounded-xl shadow-sm text-center p-4">
            <div class="text-3xl font-bold text-gray-400">{{ sin_cambios }}</div>
            <small class="text-gray-500">Sin cambios</small>
        </div>
    </div>

    <!-- Tabla preview -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6" x-data="{ filtro: 'todos' }">
        <div class="px-4 py-3 border-b border-gray-200 flex justify-between items-center flex-wrap gap-2">
            <h5 class="font-semibold text-sm">Detalle de jugadores</h5>
            <div class="flex gap-1">
                <button @click="filtro = 'todos'" :class="filtro === 'todos' ? 'bg-bridge text-white' : 'bg-gray-100 text-gray-700'" class="px-3 py-1 rounded-lg text-xs font-medium transition">Todos</button>
                <button @click="filtro = 'nuevo'" :class="filtro === 'nuevo' ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-700'" class="px-3 py-1 rounded-lg text-xs font-medium transition">Nuevos</button>
                <button @click="filtro = 'actualizar'" :class="filtro === 'actualizar' ? 'bg-yellow-600 text-white' : 'bg-gray-100 text-gray-700'" class="px-3 py-1 rounded-lg text-xs font-medium transition">Actualizados</button>
                <button @click="filtro = 'sin_cambios'" :class="filtro === 'sin_cambios' ? 'bg-gray-600 text-white' : 'bg-gray-100 text-gray-700'" class="px-3 py-1 rounded-lg text-xs font-medium transition">Sin cambios</button>
            </div>
        </div>
        <div class="overflow-x-auto max-h-96 overflow-y-auto">
            <table class="w-full">
                <thead class="bg-gray-50 sticky top-0">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase">#</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Estado</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Nombre</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Apellido</th>
                        <th class="px-3 py-2 text-center text-xs font-semibold text-gray-500 uppercase">HC</th>
                        <th class="px-3 py-2 text-center text-xs font-semibold text-gray-500 uppercase">Puntos</th>
                        <th class="px-3 py-2 text-center text-xs font-semibold text-gray-500 uppercase">CN</th>
                        <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Categoría</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for item in preview %}
                    <tr x-show="filtro === 'todos' || filtro === '{{ item.estado }}'" class="hover:bg-gray-50 transition">
                        <td class="px-3 py-2 text-gray-400 text-sm">{{ forloop.counter }}</td>
                        <td class="px-3 py-2">
                            {% if item.estado == 'nuevo' %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Nuevo</span>
                            {% elif item.estado == 'actualizar' %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Actualizar</span>
                            {% else %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">Sin cambios</span>
                            {% endif %}
                        </td>
                        <td class="px-3 py-2 text-sm">{{ item.nombre }}</td>
                        <td class="px-3 py-2 text-sm">{{ item.apellido }}</td>
                        <td class="px-3 py-2 text-center text-sm font-bold {% if item.estado == 'actualizar' %}text-yellow-600{% elif item.estado == 'nuevo' %}text-green-600{% endif %}">{{ item.handicap }}</td>
                        <td class="px-3 py-2 text-center text-sm">{{ item.puntos }}</td>
                        <td class="px-3 py-2 text-center text-sm">{{ item.cn_totales }}</td>
                        <td class="px-3 py-2 text-sm">{{ item.categoria }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Botón confirmar -->
    {% if nuevos > 0 or actualizados > 0 %}
    <div class="bg-white rounded-xl shadow-sm p-6 text-center">
        <form action="{% url 'cargar_base_confirmar' %}" method="POST">
            {% csrf_token %}
            <input type="hidden" name="datos_json" value='{{ datos_json }}'>
            <p class="mb-4 text-gray-700">
                Se agregarán <strong class="text-green-600">{{ nuevos }} jugadores nuevos</strong>
                y se actualizarán <strong class="text-yellow-600">{{ actualizados }} handicaps</strong>.
            </p>
            <button type="submit" class="inline-flex items-center gap-2 px-8 py-3 bg-bridge text-white rounded-lg hover:bg-bridge-light transition font-medium text-lg">
                <i class="bi bi-check-circle"></i> Confirmar Importación
            </button>
        </form>
    </div>
    {% else %}
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center text-blue-800">
        <i class="bi bi-info-circle"></i>
        No hay cambios para realizar. Todos los jugadores ya están al día.
    </div>
    {% endif %}
</div>
{% endif %}

{% endblock %}
