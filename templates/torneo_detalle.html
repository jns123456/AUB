{% extends "base.html" %}
{% load static bridge_tags l10n %}

{% block title %}{{ torneo.nombre }}{% endblock %}

{% block content %}
<!-- Header -->
<div class="flex justify-between items-center mb-6 flex-wrap gap-4">
    <div>
        <h2 class="text-2xl font-bold text-gray-800 mb-1">
            <i class="bi bi-trophy"></i> {{ torneo.nombre }}
        </h2>
        <p class="text-gray-500 text-sm flex items-center gap-2 flex-wrap">
            <span><i class="bi bi-calendar"></i> {{ torneo.fecha|date:"d/m/Y" }}</span>
            <span>&bull;</span>
            <span><i class="bi bi-people"></i> {{ torneo.cantidad_parejas }} parejas</span>
            <span>&bull;</span>
            {% if torneo.estado == 'equilibrado' %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Equilibrado</span>
            {% else %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">En configuración</span>
            {% endif %}
        </p>
    </div>
    <a href="{% url 'torneo_acciones' id=torneo.id %}" class="inline-flex items-center gap-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition text-sm">
        <i class="bi bi-arrow-left"></i> Volver al Menú
    </a>
</div>

<div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
    <!-- Left Column -->
    <div class="lg:col-span-5 space-y-4">
        {% if torneo.estado == 'equilibrado' %}
        <!-- Collapsible add pair form -->
        <div x-data="{ showForm: false }">
            <button @click="showForm = !showForm"
                    class="w-full px-4 py-3 border border-blue-500 text-blue-500 rounded-xl hover:bg-blue-50 transition font-medium text-sm text-center">
                <i class="bi bi-person-plus"></i> Agregar más parejas
            </button>
            <div x-show="showForm" x-transition class="mt-3">
                <div class="bg-white rounded-xl shadow-sm">
                    <div class="bg-bridge text-white px-4 py-3 rounded-t-xl">
                        <h5 class="font-semibold text-sm"><i class="bi bi-person-plus"></i> Agregar Pareja</h5>
                    </div>
                    <div class="p-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-2 text-xs text-blue-800 mb-3">
                            <i class="bi bi-info-circle"></i> Al agregar una pareja, deberás re-equilibrar el torneo.
                        </div>
                        <form action="{% url 'torneo_agregar_pareja' id=torneo.id %}" method="POST" id="formParejaEq">
                            {% csrf_token %}
                            {% include "_jugador_search_field.html" with label="Jugador 1" field_name="jugador1_id" suffix="eq" pair="1" %}
                            {% include "_jugador_search_field.html" with label="Jugador 2" field_name="jugador2_id" suffix="eq" pair="2" %}
                            <button type="submit" class="w-full px-4 py-2 bg-bridge text-white rounded-lg hover:bg-bridge-light transition text-sm font-medium">
                                <i class="bi bi-plus-circle"></i> Agregar Pareja
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Always visible add pair form -->
        <div class="bg-white rounded-xl shadow-sm">
            <div class="bg-bridge text-white px-4 py-3 rounded-t-xl">
                <h5 class="font-semibold text-sm"><i class="bi bi-person-plus"></i> Agregar Pareja</h5>
            </div>
            <div class="p-4">
                <form action="{% url 'torneo_agregar_pareja' id=torneo.id %}" method="POST" id="formParejaCfg">
                    {% csrf_token %}
                    {% include "_jugador_search_field.html" with label="Jugador 1" field_name="jugador1_id" suffix="cfg" pair="1" %}
                    {% include "_jugador_search_field.html" with label="Jugador 2" field_name="jugador2_id" suffix="cfg" pair="2" %}
                    <button type="submit" class="w-full px-4 py-2 bg-bridge text-white rounded-lg hover:bg-bridge-light transition text-sm font-medium">
                        <i class="bi bi-plus-circle"></i> Agregar Pareja
                    </button>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- Balance Button -->
        <div class="bg-white rounded-xl shadow-sm p-6 text-center">
            {% if torneo.estado == 'equilibrado' %}
                <form action="{% url 'torneo_equilibrar' id=torneo.id %}" method="POST">
                    {% csrf_token %}
                    <button type="submit" class="w-full px-6 py-3 bg-bridge text-white rounded-lg hover:bg-bridge-light transition font-medium">
                        <i class="bi bi-arrow-repeat"></i> Re-Equilibrar
                    </button>
                    <p class="text-gray-500 text-xs mt-2">Genera una nueva asignación equilibrada de NS/EO</p>
                </form>
            {% elif torneo.parejas.count >= 2 %}
                <form action="{% url 'torneo_equilibrar' id=torneo.id %}" method="POST">
                    {% csrf_token %}
                    <button type="submit" class="w-full px-6 py-4 bg-bridge text-white rounded-lg hover:bg-bridge-light transition font-semibold text-lg">
                        <i class="bi bi-lightning-fill"></i> Equilibrar Torneo
                    </button>
                    <p class="text-gray-500 text-xs mt-2">Asignar direcciones NS/EO equilibrando handicaps</p>
                </form>
            {% else %}
                <button type="button" disabled class="w-full px-6 py-4 bg-gray-300 text-gray-500 rounded-lg cursor-not-allowed font-semibold text-lg">
                    <i class="bi bi-lightning-fill"></i> Equilibrar Torneo
                </button>
                <p class="text-gray-400 text-xs mt-2">Se necesitan al menos 2 parejas para equilibrar</p>
            {% endif %}
        </div>

    </div>

    <!-- Right Column -->
    <div class="lg:col-span-7">
        {% if torneo.estado == 'equilibrado' %}
        {% with ns_parejas=torneo.parejas_ns eo_parejas=torneo.parejas_eo %}

        <!-- Mesa Assignment -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6">
            <div class="bg-bridge text-white px-4 py-3 flex justify-between items-center">
                <h5 class="font-semibold text-sm"><i class="bi bi-layout-split"></i> Asignación de Mesas</h5>
                <button type="button" id="btn-descargar-mesas" class="px-3 py-1 bg-white/20 text-white rounded text-xs hover:bg-white/30 transition">
                    <i class="bi bi-download"></i> Descargar imagen
                </button>
            </div>
            <div class="p-4" id="zona-captura-mesas">
                <div class="text-center mb-4">
                    <h5 class="font-bold text-gray-900">{{ torneo.nombre }}</h5>
                    <span class="text-gray-500 text-sm">{{ torneo.fecha|date:"d/m/Y" }} &mdash; {{ torneo.cantidad_parejas }} parejas</span>
                </div>

                <!-- Averages -->
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-ns text-white text-center rounded-lg py-3">
                        <div class="font-bold text-sm">Norte-Sur</div>
                        <div class="text-2xl font-bold" id="ns-promedio">-</div>
                        <small class="text-white/70">Prom. HC &bull; {{ ns_parejas|length }} parejas</small>
                    </div>
                    <div class="bg-eo text-white text-center rounded-lg py-3">
                        <div class="font-bold text-sm">Este-Oeste</div>
                        <div class="text-2xl font-bold" id="eo-promedio">-</div>
                        <small class="text-white/70">Prom. HC &bull; {{ eo_parejas|length }} parejas</small>
                    </div>
                </div>

                <div class="text-center mb-4">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800" id="diferencia-badge">Diferencia: -</span>
                </div>

                <!-- NS / EO Tables -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <table class="w-full text-sm border border-gray-200 rounded-lg overflow-hidden">
                            <thead>
                                <tr class="bg-ns text-white">
                                    <th class="px-2 py-2 text-left w-12">Mesa</th>
                                    <th class="px-2 py-2 text-left">Pareja</th>
                                    <th class="px-2 py-2 text-center w-10">HC</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                {% for p in ns_parejas %}
                                <tr>
                                    <td class="px-2 py-1.5 text-gray-400">{{ forloop.counter }}</td>
                                    <td class="px-2 py-1.5 text-xs">
                                        {{ p.jugador1.nombre_completo }} ({{ p.jugador1.handicap }})<br>
                                        {{ p.jugador2.nombre_completo }} ({{ p.jugador2.handicap }})
                                    </td>
                                    <td class="px-2 py-1.5 text-center font-bold">{{ p.handicap_pareja }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <table class="w-full text-sm border border-gray-200 rounded-lg overflow-hidden">
                            <thead>
                                <tr class="bg-eo text-white">
                                    <th class="px-2 py-2 text-left w-12">Mesa</th>
                                    <th class="px-2 py-2 text-left">Pareja</th>
                                    <th class="px-2 py-2 text-center w-10">HC</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                {% for p in eo_parejas %}
                                <tr>
                                    <td class="px-2 py-1.5 text-gray-400">{{ forloop.counter }}</td>
                                    <td class="px-2 py-1.5 text-xs">
                                        {{ p.jugador1.nombre_completo }} ({{ p.jugador1.handicap }})<br>
                                        {{ p.jugador2.nombre_completo }} ({{ p.jugador2.handicap }})
                                    </td>
                                    <td class="px-2 py-1.5 text-center font-bold">{{ p.handicap_pareja }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <small class="text-gray-400">Asociación Uruguaya de Bridge</small>
                </div>
            </div>
        </div>

        {% endwith %}

        {% else %}
        <!-- Pairs list (not balanced) -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-200">
                <h5 class="font-semibold text-sm">
                    <i class="bi bi-people"></i> Parejas del Torneo
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-bridge text-white ml-2">{{ torneo.parejas.count }}</span>
                </h5>
            </div>
            {% if torneo.parejas.count > 0 %}
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase">#</th>
                            <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Jugador 1</th>
                            <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Jugador 2</th>
                            <th class="px-3 py-3 text-center text-xs font-semibold text-gray-500 uppercase">HC Pareja</th>
                            <th class="px-3 py-3 text-right text-xs font-semibold text-gray-500 uppercase">Acción</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% for p in torneo.parejas.all %}
                        <tr class="hover:bg-gray-50 transition">
                            <td class="px-3 py-2.5 text-gray-400 text-sm">{{ forloop.counter }}</td>
                            <td class="px-3 py-2.5 text-sm">
                                {{ p.jugador1.nombre_completo }}
                                <span class="text-gray-400">({{ p.jugador1.handicap }})</span>
                            </td>
                            <td class="px-3 py-2.5 text-sm">
                                {{ p.jugador2.nombre_completo }}
                                <span class="text-gray-400">({{ p.jugador2.handicap }})</span>
                            </td>
                            <td class="px-3 py-2.5 text-center">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-bridge text-white">{{ p.handicap_pareja }}</span>
                            </td>
                            <td class="px-3 py-2.5 text-right">
                                <form action="{% url 'torneo_eliminar_pareja' id=torneo.id pareja_id=p.id %}"
                                      method="POST" class="inline" onsubmit="return confirm('¿Eliminar esta pareja?')">
                                    {% csrf_token %}
                                    <button type="submit" class="p-1.5 text-red-500 hover:bg-red-50 rounded-lg transition">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-12 text-gray-400">
                <i class="bi bi-people" style="font-size: 3rem;"></i>
                <p class="mt-3 text-gray-500">No hay parejas registradas.</p>
                <p class="text-sm text-gray-400">Usá el formulario de la izquierda para agregar parejas.</p>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Data for JS -->
<script>
    var TORNEO_ID = {{ torneo.id }};
    var API_BUSCAR_JUGADORES = "{% url 'api_buscar_jugadores' %}";
    {% localize off %}
    var NS_HANDICAPS = [{% for p in torneo.parejas_ns %}{{ p.handicap_pareja }},{% endfor %}];
    var EO_HANDICAPS = [{% for p in torneo.parejas_eo %}{{ p.handicap_pareja }},{% endfor %}];
    {% endlocalize %}
</script>
{% endblock %}

{% block scripts %}
<script>
// Calculate and display averages
(function() {
    function calcularPromedio(arr) {
        if (arr.length === 0) return 0;
        return arr.reduce((a, b) => a + b, 0) / arr.length;
    }
    var nsPromedio = calcularPromedio(NS_HANDICAPS);
    var eoPromedio = calcularPromedio(EO_HANDICAPS);
    var diferencia = Math.abs(nsPromedio - eoPromedio);

    var nsEl = document.getElementById('ns-promedio');
    var eoEl = document.getElementById('eo-promedio');
    var diffEl = document.getElementById('diferencia-badge');

    if (nsEl && NS_HANDICAPS.length > 0) nsEl.textContent = nsPromedio.toFixed(2);
    if (eoEl && EO_HANDICAPS.length > 0) eoEl.textContent = eoPromedio.toFixed(2);
    if (diffEl && NS_HANDICAPS.length > 0 && EO_HANDICAPS.length > 0) {
        diffEl.textContent = 'Diferencia: ' + diferencia.toFixed(2);
        if (diferencia <= 0.5) diffEl.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800';
        else if (diferencia <= 1.0) diffEl.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800';
        else diffEl.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800';
    }
})();

// Player search with API
(function() {
    const wrappers = document.querySelectorAll('.jugador-search-wrapper');
    if (wrappers.length === 0) return;
    const seleccionados = {};
    let searchTimeout = null;

    wrappers.forEach(wrapper => {
        const input = wrapper.querySelector('.jugador-search');
        const hiddenInput = wrapper.querySelector('input[type="hidden"]');
        const resultsDiv = wrapper.querySelector('.jugador-search-results');
        const selectedDiv = wrapper.querySelector('.jugador-selected');
        const selectedName = wrapper.querySelector('.selected-name');
        const clearBtn = wrapper.querySelector('.jugador-clear');
        if (!input || !resultsDiv) return;

        const suffix = input.dataset.suffix || 'default';
        const pair = input.dataset.pair || '1';
        if (!seleccionados[suffix]) seleccionados[suffix] = {};

        function getOtherSelectedId() {
            return seleccionados[suffix][pair === '1' ? '2' : '1'] || null;
        }

        function showResults() { resultsDiv.style.display = 'block'; }
        function hideResults() { resultsDiv.style.display = 'none'; resultsDiv.innerHTML = ''; }

        function buscarJugadores(query) {
            if (query.trim().length < 1) { hideResults(); return; }
            resultsDiv.innerHTML = '<div class="p-3 text-center text-gray-400 text-sm italic">Buscando...</div>';
            showResults();

            const params = new URLSearchParams({ q: query.trim(), torneo_id: TORNEO_ID });
            const otherId = getOtherSelectedId();
            if (otherId) params.append('excluir', otherId);

            fetch(API_BUSCAR_JUGADORES + '?' + params.toString())
                .then(r => r.json())
                .then(data => {
                    const jugadores = data.jugadores || [];
                    if (jugadores.length === 0) {
                        resultsDiv.innerHTML = '<div class="p-3 text-center text-gray-400 text-sm italic">Sin resultados</div>';
                        showResults();
                        return;
                    }
                    resultsDiv.innerHTML = jugadores.map(j =>
                        '<div class="search-result-item px-3 py-2 cursor-pointer hover:bg-bridge hover:text-white transition border-b border-gray-100 last:border-0" data-id="'+j.id+'" data-nombre="'+j.nombre+'" data-apellido="'+j.apellido+'" data-handicap="'+j.handicap+'">' +
                        '<span class="font-medium text-sm">'+j.apellido+', '+j.nombre+'</span> ' +
                        '<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs bg-gray-200 text-gray-700 ml-1">HC: '+j.handicap+'</span></div>'
                    ).join('');
                    showResults();

                    resultsDiv.querySelectorAll('.search-result-item').forEach(item => {
                        item.addEventListener('mousedown', function(e) {
                            e.preventDefault();
                            hiddenInput.value = this.dataset.id;
                            seleccionados[suffix][pair] = parseInt(this.dataset.id);
                            input.value = '';
                            input.style.display = 'none';
                            selectedName.textContent = this.dataset.apellido + ', ' + this.dataset.nombre + ' (HC: ' + this.dataset.handicap + ')';
                            selectedDiv.style.display = 'flex';
                            hideResults();
                        });
                    });
                })
                .catch(() => { resultsDiv.innerHTML = '<div class="p-3 text-center text-red-500 text-sm">Error en la búsqueda</div>'; showResults(); });
        }

        input.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => buscarJugadores(this.value), 200);
        });
        input.addEventListener('focus', function() { if (this.value.trim()) buscarJugadores(this.value); });
        input.addEventListener('blur', function() { setTimeout(() => { hideResults(); }, 250); });

        if (clearBtn) {
            clearBtn.addEventListener('click', function() {
                hiddenInput.value = '';
                delete seleccionados[suffix][pair];
                input.style.display = '';
                input.value = '';
                selectedDiv.style.display = 'none';
                input.focus();
            });
        }
    });
})();

// Download image
(function() {
    const btn = document.getElementById('btn-descargar-mesas');
    if (!btn) return;
    btn.addEventListener('click', function() {
        const zona = document.getElementById('zona-captura-mesas');
        if (!zona) return;
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Generando...';
        html2canvas(zona, { scale: 2, backgroundColor: '#ffffff', useCORS: true, logging: false })
            .then(canvas => {
                const link = document.createElement('a');
                const titulo = zona.querySelector('h5');
                const nombre = titulo ? titulo.textContent.trim().replace(/[^a-zA-Z0-9áéíóúñÁÉÍÓÚÑ ]/g, '').replace(/\s+/g, '_') : 'mesas';
                link.download = 'AUB_' + nombre + '.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-download"></i> Descargar imagen';
            })
            .catch(() => { btn.disabled = false; btn.innerHTML = '<i class="bi bi-download"></i> Descargar imagen'; });
    });
})();
</script>
{% endblock %}
