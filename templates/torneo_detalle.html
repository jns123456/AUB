{% extends "base.html" %}
{% load static bridge_tags l10n %}

{% block title %}{{ torneo.nombre }}{% endblock %}

{% block content %}
<!-- Encabezado del torneo -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">
            <i class="bi bi-trophy"></i> {{ torneo.nombre }}
        </h2>
        <p class="text-muted mb-0">
            <i class="bi bi-calendar"></i> {{ torneo.fecha|date:"d/m/Y" }}
            &nbsp;&bull;&nbsp;
            <i class="bi bi-people"></i> {{ torneo.cantidad_parejas }} parejas
            &nbsp;&bull;&nbsp;
            {% if torneo.estado == 'equilibrado' %}
                <span class="badge bg-success">Equilibrado</span>
            {% else %}
                <span class="badge bg-secondary">En configuración</span>
            {% endif %}
        </p>
    </div>
    <a href="{% url 'torneos' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Volver
    </a>
</div>

<div class="row g-4">
    <!-- Columna izquierda: Agregar parejas y acciones -->
    <div class="col-lg-5">
        {% if torneo.estado == 'equilibrado' %}
        <!-- Formulario colapsable para agregar parejas en vista equilibrada -->
        <div class="mb-4">
            <button class="btn btn-outline-primary btn-lg w-100 mb-2" type="button"
                    data-bs-toggle="collapse" data-bs-target="#formAgregarPareja">
                <i class="bi bi-person-plus"></i> Agregar más parejas
            </button>
            <div class="collapse" id="formAgregarPareja">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-bridge text-white">
                        <h5 class="mb-0"><i class="bi bi-person-plus"></i> Agregar Pareja</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info small py-2 mb-3">
                            <i class="bi bi-info-circle"></i>
                            Al agregar una pareja, deberás re-equilibrar el torneo.
                        </div>
                        <form action="{% url 'torneo_agregar_pareja' id=torneo.id %}" method="POST" id="formParejaEq">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label class="form-label">Jugador 1</label>
                                <div class="jugador-search-wrapper" data-target="jugador1_id_eq">
                                    <input type="text" class="form-control jugador-search"
                                           placeholder="Buscar por nombre o apellido..."
                                           autocomplete="off" data-pair="1" data-suffix="eq">
                                    <input type="hidden" name="jugador1_id" id="jugador1_id_eq" required>
                                    <div class="jugador-search-results"></div>
                                    <div class="jugador-selected small text-success mt-1" style="display:none;">
                                        <i class="bi bi-check-circle"></i> <span class="selected-name"></span>
                                        <button type="button" class="btn btn-sm btn-link text-danger p-0 ms-2 jugador-clear">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Jugador 2</label>
                                <div class="jugador-search-wrapper" data-target="jugador2_id_eq">
                                    <input type="text" class="form-control jugador-search"
                                           placeholder="Buscar por nombre o apellido..."
                                           autocomplete="off" data-pair="2" data-suffix="eq">
                                    <input type="hidden" name="jugador2_id" id="jugador2_id_eq" required>
                                    <div class="jugador-search-results"></div>
                                    <div class="jugador-selected small text-success mt-1" style="display:none;">
                                        <i class="bi bi-check-circle"></i> <span class="selected-name"></span>
                                        <button type="button" class="btn btn-sm btn-link text-danger p-0 ms-2 jugador-clear">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-bridge w-100">
                                <i class="bi bi-plus-circle"></i> Agregar Pareja
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Formulario siempre visible en modo configuración -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-bridge text-white">
                <h5 class="mb-0"><i class="bi bi-person-plus"></i> Agregar Pareja</h5>
            </div>
            <div class="card-body">
                <form action="{% url 'torneo_agregar_pareja' id=torneo.id %}" method="POST" id="formParejaCfg">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Jugador 1</label>
                        <div class="jugador-search-wrapper" data-target="jugador1_id_cfg">
                            <input type="text" class="form-control jugador-search"
                                   placeholder="Buscar por nombre o apellido..."
                                   autocomplete="off" data-pair="1" data-suffix="cfg">
                            <input type="hidden" name="jugador1_id" id="jugador1_id_cfg" required>
                            <div class="jugador-search-results"></div>
                            <div class="jugador-selected small text-success mt-1" style="display:none;">
                                <i class="bi bi-check-circle"></i> <span class="selected-name"></span>
                                <button type="button" class="btn btn-sm btn-link text-danger p-0 ms-2 jugador-clear">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Jugador 2</label>
                        <div class="jugador-search-wrapper" data-target="jugador2_id_cfg">
                            <input type="text" class="form-control jugador-search"
                                   placeholder="Buscar por nombre o apellido..."
                                   autocomplete="off" data-pair="2" data-suffix="cfg">
                            <input type="hidden" name="jugador2_id" id="jugador2_id_cfg" required>
                            <div class="jugador-search-results"></div>
                            <div class="jugador-selected small text-success mt-1" style="display:none;">
                                <i class="bi bi-check-circle"></i> <span class="selected-name"></span>
                                <button type="button" class="btn btn-sm btn-link text-danger p-0 ms-2 jugador-clear">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-bridge w-100">
                        <i class="bi bi-plus-circle"></i> Agregar Pareja
                    </button>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- Botón Equilibrar -->
        {% if torneo.parejas.count >= 2 %}
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body text-center p-4">
                {% if torneo.estado == 'equilibrado' %}
                    <form action="{% url 'torneo_equilibrar' id=torneo.id %}" method="POST">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-bridge btn-lg w-100">
                            <i class="bi bi-arrow-repeat"></i> Re-Equilibrar
                        </button>
                        <p class="text-muted small mt-2 mb-0">
                            Genera una nueva asignación equilibrada de NS/EO
                        </p>
                    </form>
                {% else %}
                    <form action="{% url 'torneo_equilibrar' id=torneo.id %}" method="POST">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-bridge btn-lg w-100 py-3">
                            <i class="bi bi-lightning-fill"></i> Equilibrar Torneo
                        </button>
                        <p class="text-muted small mt-2 mb-0">
                            Asignar direcciones NS/EO equilibrando handicaps
                        </p>
                    </form>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Botón Importar Resultados -->
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center p-4">
                <a href="{% url 'torneo_importar_resultados' id=torneo.id %}" class="btn btn-outline-primary btn-lg w-100">
                    <i class="bi bi-file-earmark-arrow-up"></i> Importar Resultados
                </a>
                <p class="text-muted small mt-2 mb-0">
                    Cargar archivos Ranks.txt y Travellers.txt del torneo
                </p>
                {% if torneo.resultado_importado %}
                <div class="mt-3">
                    <a href="{% url 'torneo_ver_resultados' id=torneo.id %}" class="btn btn-sm btn-success">
                        <i class="bi bi-eye"></i> Ver Resultados Importados
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Columna derecha: Parejas y resultados -->
    <div class="col-lg-7">
        {% if torneo.estado == 'equilibrado' %}
        {% with ns_parejas=torneo.parejas_ns eo_parejas=torneo.parejas_eo %}

        <!-- SECCIÓN 1: ASIGNACIÓN DE MESAS -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-bridge text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-layout-split"></i> Asignación de Mesas</h5>
                <button type="button" class="btn btn-sm btn-light" id="btn-descargar-mesas"
                        title="Descargar imagen para compartir por WhatsApp">
                    <i class="bi bi-download"></i> Descargar imagen
                </button>
            </div>
            <div class="card-body" id="zona-captura-mesas">
                <!-- Título del torneo -->
                <div class="text-center mb-3">
                    <h5 class="fw-bold mb-1">{{ torneo.nombre }}</h5>
                    <span class="text-muted">{{ torneo.fecha|date:"d/m/Y" }} &mdash; {{ torneo.cantidad_parejas }} parejas</span>
                </div>

                <!-- Promedios -->
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="bg-ns text-white text-center rounded py-2">
                            <div class="fw-bold">Norte-Sur</div>
                            <div class="fs-4 fw-bold" id="ns-promedio">
                                {% if ns_parejas %}
                                    {% widthratio 1 1 1 as one %}
                                    {% with total=0 count=0 %}
                                    {% for p in ns_parejas %}{% endfor %}
                                    {% endwith %}
                                {% endif %}
                                -
                            </div>
                            <small>Prom. HC &bull; {{ ns_parejas|length }} parejas</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="bg-eo text-white text-center rounded py-2">
                            <div class="fw-bold">Este-Oeste</div>
                            <div class="fs-4 fw-bold" id="eo-promedio">-</div>
                            <small>Prom. HC &bull; {{ eo_parejas|length }} parejas</small>
                        </div>
                    </div>
                </div>

                <!-- Diferencia -->
                <div class="text-center mb-3">
                    <span class="badge fs-6 bg-info" id="diferencia-badge">Diferencia: -</span>
                </div>

                <!-- Tablas NS y EO -->
                <div class="row g-2">
                    <div class="col-6">
                        <table class="table table-sm table-bordered mb-0">
                            <thead>
                                <tr class="bg-ns text-white">
                                    <th style="width:55px">Mesa</th>
                                    <th>Pareja</th>
                                    <th class="text-center" style="width:45px">HC</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for p in ns_parejas %}
                                <tr>
                                    <td class="text-muted">{{ forloop.counter }}</td>
                                    <td>
                                        <small>
                                            {{ p.jugador1.nombre_completo }} ({{ p.jugador1.handicap }})<br>
                                            {{ p.jugador2.nombre_completo }} ({{ p.jugador2.handicap }})
                                        </small>
                                    </td>
                                    <td class="text-center fw-bold">{{ p.handicap_pareja }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="col-6">
                        <table class="table table-sm table-bordered mb-0">
                            <thead>
                                <tr class="bg-eo text-white">
                                    <th style="width:55px">Mesa</th>
                                    <th>Pareja</th>
                                    <th class="text-center" style="width:45px">HC</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for p in eo_parejas %}
                                <tr>
                                    <td class="text-muted">{{ forloop.counter }}</td>
                                    <td>
                                        <small>
                                            {{ p.jugador1.nombre_completo }} ({{ p.jugador1.handicap }})<br>
                                            {{ p.jugador2.nombre_completo }} ({{ p.jugador2.handicap }})
                                        </small>
                                    </td>
                                    <td class="text-center fw-bold">{{ p.handicap_pareja }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Footer de la imagen -->
                <div class="text-center mt-2">
                    <small class="text-muted">Asociación Uruguaya de Bridge</small>
                </div>
            </div>
        </div>

        <!-- SECCIÓN 2: RESULTADOS Y PUNTAJES -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-award"></i> Resultados y Puntajes</h5>
            </div>
            <div class="card-body">
                <form action="{% url 'torneo_resultados' id=torneo.id %}" method="POST" id="formResultados">
                    {% csrf_token %}
                    <!-- Tipo de torneo -->
                    <div class="row align-items-center mb-3">
                        <div class="col-auto">
                            <label for="tipo_torneo" class="form-label mb-0 fw-bold small">
                                <i class="bi bi-tag"></i> Tipo de Torneo
                            </label>
                        </div>
                        <div class="col">
                            <select class="form-select form-select-sm" id="tipo_torneo" name="tipo_torneo">
                                {% for key, label in tipos_torneo.items %}
                                <option value="{{ key }}" {% if torneo.tipo == key %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <span class="badge bg-light text-dark small" id="tabla-puntos-preview"></span>
                    </div>

                    <!-- Tablas NS y EO con posiciones -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <h6 class="text-primary"><i class="bi bi-arrow-up"></i> Norte-Sur</h6>
                            <table class="table table-sm table-bordered mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Pareja</th>
                                        <th class="text-center" style="width:80px">Pos.</th>
                                        <th class="text-center" style="width:70px">%</th>
                                        <th class="text-center" style="width:55px">Pts</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for p in ns_parejas %}
                                    <tr>
                                        <td>
                                            <small>
                                                {{ p.jugador1.apellido }} &amp; {{ p.jugador2.apellido }}
                                            </small>
                                            <small class="text-muted d-block">HC: {{ p.handicap_pareja }}</small>
                                        </td>
                                        <td class="text-center">
                                            <select class="form-select form-select-sm pos-select" name="pos_{{ p.id }}"
                                                    data-pareja-id="{{ p.id }}" data-direccion="NS">
                                                <option value="">-</option>
                                                {% for i in "123456789012345678901234567890"|make_list %}
                                                    {% if forloop.counter <= ns_parejas|length %}
                                                    <option value="{{ forloop.counter }}" {% if p.posicion_final == forloop.counter %}selected{% endif %}>{{ forloop.counter }}º</option>
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td class="text-center">
                                            <input type="number" class="form-control form-control-sm pct-input text-center"
                                                   name="pct_{{ p.id }}" data-pareja-id="{{ p.id }}" data-direccion="NS"
                                                   min="0" max="100" step="0.01" placeholder="%"
                                                   value="{% if p.porcentaje %}{{ p.porcentaje }}{% endif %}">
                                        </td>
                                        <td class="text-center">
                                            <span class="fw-bold puntos-display" data-pareja-id="{{ p.id }}">
                                                {% if p.puntos_ranking %}{{ p.puntos_ranking|floatformat:0 }}{% else %}-{% endif %}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-danger"><i class="bi bi-arrow-right"></i> Este-Oeste</h6>
                            <table class="table table-sm table-bordered mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Pareja</th>
                                        <th class="text-center" style="width:80px">Pos.</th>
                                        <th class="text-center" style="width:70px">%</th>
                                        <th class="text-center" style="width:55px">Pts</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for p in eo_parejas %}
                                    <tr>
                                        <td>
                                            <small>
                                                {{ p.jugador1.apellido }} &amp; {{ p.jugador2.apellido }}
                                            </small>
                                            <small class="text-muted d-block">HC: {{ p.handicap_pareja }}</small>
                                        </td>
                                        <td class="text-center">
                                            <select class="form-select form-select-sm pos-select" name="pos_{{ p.id }}"
                                                    data-pareja-id="{{ p.id }}" data-direccion="EO">
                                                <option value="">-</option>
                                                {% for i in "123456789012345678901234567890"|make_list %}
                                                    {% if forloop.counter <= eo_parejas|length %}
                                                    <option value="{{ forloop.counter }}" {% if p.posicion_final == forloop.counter %}selected{% endif %}>{{ forloop.counter }}º</option>
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td class="text-center">
                                            <input type="number" class="form-control form-control-sm pct-input text-center"
                                                   name="pct_{{ p.id }}" data-pareja-id="{{ p.id }}" data-direccion="EO"
                                                   min="0" max="100" step="0.01" placeholder="%"
                                                   value="{% if p.porcentaje %}{{ p.porcentaje }}{% endif %}">
                                        </td>
                                        <td class="text-center">
                                            <span class="fw-bold puntos-display" data-pareja-id="{{ p.id }}">
                                                {% if p.puntos_ranking %}{{ p.puntos_ranking|floatformat:0 }}{% else %}-{% endif %}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="text-center mt-3">
                        <button type="submit" class="btn btn-bridge btn-lg">
                            <i class="bi bi-check-circle"></i> Guardar Resultados
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% endwith %}

        {% else %}
        <!-- LISTA DE PAREJAS SIN EQUILIBRAR -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-people"></i> Parejas del Torneo
                    <span class="badge bg-bridge ms-2">{{ torneo.parejas.count }}</span>
                </h5>
            </div>
            <div class="card-body p-0">
                {% if torneo.parejas.count > 0 %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Jugador 1</th>
                                <th>Jugador 2</th>
                                <th class="text-center">HC Pareja</th>
                                <th class="text-end">Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in torneo.parejas.all %}
                            <tr>
                                <td class="text-muted">{{ forloop.counter }}</td>
                                <td>
                                    {{ p.jugador1.nombre_completo }}
                                    <small class="text-muted">({{ p.jugador1.handicap }})</small>
                                </td>
                                <td>
                                    {{ p.jugador2.nombre_completo }}
                                    <small class="text-muted">({{ p.jugador2.handicap }})</small>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-bridge fs-6">{{ p.handicap_pareja }}</span>
                                </td>
                                <td class="text-end">
                                    <form action="{% url 'torneo_eliminar_pareja' id=torneo.id pareja_id=p.id %}"
                                          method="POST" class="d-inline"
                                          onsubmit="return confirm('¿Eliminar esta pareja?')">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center p-5 text-muted">
                    <i class="bi bi-people display-4"></i>
                    <p class="mt-3">No hay parejas registradas.</p>
                    <p>Usá el formulario de la izquierda para agregar parejas.</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Datos para el buscador y cálculos -->
<script>
    // ID del torneo para la API
    var TORNEO_ID = {{ torneo.id }};
    
    // URL de la API de búsqueda
    var API_BUSCAR_JUGADORES = "{% url 'api_buscar_jugadores' %}";

    // Tablas de puntos de ranking por tipo de torneo
    var TABLAS_PUNTOS = {{ tablas_puntos|to_json }};
    
    // Datos para calcular promedios
    {% localize off %}
    var NS_HANDICAPS = [{% for p in torneo.parejas_ns %}{{ p.handicap_pareja }},{% endfor %}];
    var EO_HANDICAPS = [{% for p in torneo.parejas_eo %}{{ p.handicap_pareja }},{% endfor %}];
    {% endlocalize %}
</script>
{% endblock %}

{% block scripts %}
<script>
// Calcular y mostrar promedios
(function() {
    function calcularPromedio(arr) {
        if (arr.length === 0) return 0;
        var sum = arr.reduce((a, b) => a + b, 0);
        return sum / arr.length;
    }
    
    var nsPromedio = calcularPromedio(NS_HANDICAPS);
    var eoPromedio = calcularPromedio(EO_HANDICAPS);
    var diferencia = Math.abs(nsPromedio - eoPromedio);
    
    var nsEl = document.getElementById('ns-promedio');
    var eoEl = document.getElementById('eo-promedio');
    var diffEl = document.getElementById('diferencia-badge');
    
    if (nsEl && NS_HANDICAPS.length > 0) nsEl.textContent = nsPromedio.toFixed(2);
    if (eoEl && EO_HANDICAPS.length > 0) eoEl.textContent = eoPromedio.toFixed(2);
    if (diffEl && NS_HANDICAPS.length > 0 && EO_HANDICAPS.length > 0) {
        diffEl.textContent = 'Diferencia: ' + diferencia.toFixed(2);
        if (diferencia <= 0.5) {
            diffEl.className = 'badge fs-6 bg-success';
        } else if (diferencia <= 1.0) {
            diffEl.className = 'badge fs-6 bg-warning text-dark';
        } else {
            diffEl.className = 'badge fs-6 bg-danger';
        }
    }
})();

// Buscador de jugadores con API
(function() {
    console.log('Iniciando buscador de jugadores...');
    console.log('API URL:', API_BUSCAR_JUGADORES);
    console.log('Torneo ID:', TORNEO_ID);
    
    const wrappers = document.querySelectorAll('.jugador-search-wrapper');
    console.log('Wrappers encontrados:', wrappers.length);
    
    if (wrappers.length === 0) {
        console.error('No se encontraron wrappers de busqueda!');
        return;
    }
    
    const seleccionados = {};
    let searchTimeout = null;

    wrappers.forEach((wrapper, idx) => {
        console.log('Configurando wrapper', idx);
        
        const input = wrapper.querySelector('.jugador-search');
        const hiddenInput = wrapper.querySelector('input[type="hidden"]');
        const resultsDiv = wrapper.querySelector('.jugador-search-results');
        const selectedDiv = wrapper.querySelector('.jugador-selected');
        const selectedName = wrapper.querySelector('.selected-name');
        const clearBtn = wrapper.querySelector('.jugador-clear');
        
        if (!input) { console.error('No se encontro input en wrapper', idx); return; }
        if (!resultsDiv) { console.error('No se encontro resultsDiv en wrapper', idx); return; }
        
        const suffix = input.dataset.suffix || 'default';
        const pair = input.dataset.pair || '1';
        const formKey = suffix;

        console.log('Input configurado:', { suffix, pair });

        if (!seleccionados[formKey]) seleccionados[formKey] = {};

        function getOtherSelectedId() {
            const otherPair = pair === '1' ? '2' : '1';
            return seleccionados[formKey][otherPair] || null;
        }

        function buscarJugadores(query) {
            const q = query.trim();
            console.log('Buscando:', q);
            
            if (q.length < 1) { 
                resultsDiv.innerHTML = ''; 
                return; 
            }

            // Mostrar indicador de carga
            resultsDiv.innerHTML = '<div class="search-no-results"><i class="bi bi-hourglass-split"></i> Buscando...</div>';

            // Construir URL con parametros
            const params = new URLSearchParams({
                q: q,
                torneo_id: TORNEO_ID
            });
            
            const otherId = getOtherSelectedId();
            if (otherId) {
                params.append('excluir', otherId);
            }

            const url = API_BUSCAR_JUGADORES + '?' + params.toString();
            console.log('Fetch URL:', url);

            fetch(url)
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Data recibida:', data);
                    const jugadores = data.jugadores || [];
                    
                    if (jugadores.length === 0) {
                        resultsDiv.innerHTML = '<div class="search-no-results">Sin resultados</div>';
                        return;
                    }

                    resultsDiv.innerHTML = jugadores.map(j =>
                        '<div class="search-result-item" data-id="' + j.id + '" data-nombre="' + j.nombre + '" data-apellido="' + j.apellido + '" data-handicap="' + j.handicap + '">' +
                            '<span class="fw-semibold">' + j.apellido + ', ' + j.nombre + '</span>' +
                            '<span class="badge bg-secondary ms-2">HC: ' + j.handicap + '</span>' +
                        '</div>'
                    ).join('');
                    
                    console.log('Resultados renderizados:', jugadores.length);

                    resultsDiv.querySelectorAll('.search-result-item').forEach(item => {
                        item.addEventListener('mousedown', function(e) {
                            e.preventDefault();
                            const id = parseInt(this.dataset.id);
                            const nombre = this.dataset.nombre;
                            const apellido = this.dataset.apellido;
                            const handicap = this.dataset.handicap;

                            console.log('Jugador seleccionado:', { id, nombre, apellido, handicap });

                            hiddenInput.value = id;
                            seleccionados[formKey][pair] = id;
                            input.value = '';
                            input.style.display = 'none';
                            selectedName.textContent = apellido + ', ' + nombre + ' (HC: ' + handicap + ')';
                            selectedDiv.style.display = 'block';
                            resultsDiv.innerHTML = '';
                        });
                    });
                })
                .catch(error => {
                    console.error('Error buscando jugadores:', error);
                    resultsDiv.innerHTML = '<div class="search-no-results text-danger">Error en la busqueda</div>';
                });
        }

        input.addEventListener('input', function() {
            console.log('Input event:', this.value);
            // Debounce: esperar 200ms antes de buscar
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                buscarJugadores(this.value);
            }, 200);
        });

        input.addEventListener('focus', function() {
            console.log('Focus event');
            if (this.value.trim()) buscarJugadores(this.value);
        });

        input.addEventListener('blur', function() {
            console.log('Blur event');
            setTimeout(() => { resultsDiv.innerHTML = ''; }, 250);
        });

        if (clearBtn) {
            clearBtn.addEventListener('click', function() {
                console.log('Clear button clicked');
                hiddenInput.value = '';
                delete seleccionados[formKey][pair];
                input.style.display = '';
                input.value = '';
                selectedDiv.style.display = 'none';
                input.focus();
            });
        }
    });
    
    console.log('Buscador de jugadores inicializado correctamente');
})();

// Auto-cálculo de puntos de ranking
(function() {
    const tipoSelect = document.getElementById('tipo_torneo');
    const preview = document.getElementById('tabla-puntos-preview');
    const posSelects = document.querySelectorAll('.pos-select');
    const pctInputs = document.querySelectorAll('.pct-input');
    const formResultados = document.getElementById('formResultados');

    if (!tipoSelect || !posSelects.length) return;

    function getTabla() {
        return TABLAS_PUNTOS[tipoSelect.value] || [];
    }

    function getTipo() {
        return tipoSelect.value;
    }

    function actualizarPreview() {
        const tabla = getTabla();
        const tipo = getTipo();
        if (tipo === 'handicap') {
            preview.innerHTML = '<span class="text-info">Art. 38:</span> ≥58%: (%-50) pts | 50-57.99%: 1º=10, 2º=5, 3º=3, 4º=1 | <50%: 0 pts';
        } else if (tabla.length) {
            preview.textContent = 'Puntos: ' + tabla.map((p, i) => (i + 1) + 'º=' + p).join(', ');
        } else {
            preview.textContent = '';
        }
    }

    function calcularPuntos() {
        const tabla = getTabla();
        const tipo = getTipo();

        posSelects.forEach(sel => {
            const parejaId = sel.dataset.parejaId;
            const display = document.querySelector('.puntos-display[data-pareja-id="' + parejaId + '"]');
            const pctInput = document.querySelector('.pct-input[data-pareja-id="' + parejaId + '"]');
            if (!display) return;

            const pos = parseInt(sel.value);
            const pct = pctInput ? parseFloat(pctInput.value) : null;

            let puntos = null;

            if (pos) {
                if (tipo === 'handicap' && pct !== null && !isNaN(pct)) {
                    if (pos <= 4) {
                        if (pct >= 58) {
                            puntos = Math.ceil(pct - 50);
                        } else if (pct >= 50) {
                            puntos = pos <= tabla.length ? tabla[pos - 1] : 0;
                        } else {
                            puntos = 0;
                        }
                    } else {
                        puntos = 0;
                    }
                } else if (tipo === 'handicap' && (pct === null || isNaN(pct))) {
                    display.textContent = '?';
                    display.classList.remove('text-success');
                    display.classList.add('text-warning');
                    return;
                } else {
                    if (pos >= 1 && pos <= tabla.length) {
                        puntos = tabla[pos - 1];
                    } else {
                        puntos = 0;
                    }
                }
            }

            if (puntos !== null) {
                display.textContent = puntos;
                display.classList.add('text-success');
                display.classList.remove('text-muted', 'text-warning');
            } else {
                display.textContent = '-';
                display.classList.remove('text-success', 'text-warning');
                display.classList.add('text-muted');
            }
        });
    }

    tipoSelect.addEventListener('change', function() {
        actualizarPreview();
        calcularPuntos();
    });

    posSelects.forEach(sel => {
        sel.addEventListener('change', function() {
            calcularPuntos();
        });
    });

    pctInputs.forEach(input => {
        input.addEventListener('input', function() {
            calcularPuntos();
        });
    });

    actualizarPreview();
    calcularPuntos();
})();

// Descargar imagen
(function() {
    const btn = document.getElementById('btn-descargar-mesas');
    if (!btn) return;

    btn.addEventListener('click', function() {
        const zona = document.getElementById('zona-captura-mesas');
        if (!zona) return;

        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Generando...';

        html2canvas(zona, {
            scale: 2,
            backgroundColor: '#ffffff',
            useCORS: true,
            logging: false,
        }).then(function(canvas) {
            const link = document.createElement('a');
            const titulo = document.querySelector('#zona-captura-mesas h5');
            const nombre = titulo ? titulo.textContent.trim().replace(/[^a-zA-Z0-9áéíóúñÁÉÍÓÚÑ ]/g, '').replace(/\s+/g, '_') : 'mesas';
            link.download = 'AUB_' + nombre + '.png';
            link.href = canvas.toDataURL('image/png');
            link.click();

            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-download"></i> Descargar imagen';
        }).catch(function() {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-download"></i> Descargar imagen';
            alert('Error al generar la imagen. Intentá de nuevo.');
        });
    });
})();
</script>
{% endblock %}
